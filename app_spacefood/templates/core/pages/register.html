{% extends 'core/layout/base.html' %}
{% load static %}

{% block contenido %}
<div class="container mt-5">
  <div class="logo text-center mb-4">
    <img src="{% static 'core/imgs/logo.png' %}" alt="Logo SpaceFood" width="350">
  </div>

  <!-- Formulario con validación de Bootstrap -->
  <form class="row g-3 needs-validation formulario mx-auto" novalidate>
    <!-- Nombre -->
    <div class="col-md-6">
      <div class="form-floating">
        <input type="text" class="form-control form-control-sm-custom" id="nombre" placeholder="Nombre" required>
        <label for="nombre">Nombre</label>
        <div class="invalid-feedback">
          Por favor ingresa tu nombre.
        </div>
      </div>
    </div>

    <!-- Apellido -->
    <div class="col-md-6">
      <div class="form-floating">
        <input type="text" class="form-control form-control-sm-custom" id="apellido" placeholder="Apellido" required>
        <label for="apellido">Apellido</label>
        <div class="invalid-feedback">
          Por favor ingresa tu apellido.
        </div>
      </div>
    </div>

    <!-- RUT -->
    <div class="col-md-6">
      <div class="form-floating">
        <input type="text" class="form-control form-control-sm-custom" id="rut" placeholder="11.111.111-1" pattern="^[0-9]{1,2}\.[0-9]{3}\.[0-9]{3}-[0-9kK]{1}$" required>
        <label for="rut">RUT</label>
        <div class="invalid-feedback">
          Ingresa un RUT válido (formato 11.111.111-1).
        </div>
      </div>
    </div>

    <!-- Correo -->
    <div class="col-md-6">
      <div class="form-floating">
        <input type="email" class="form-control form-control-sm-custom" id="correo" placeholder="name@example.com" required>
        <label for="correo">Correo</label>
        <div class="invalid-feedback">
          Ingresa un correo electrónico válido.
        </div>
      </div>
    </div>

    <!-- Contraseña -->
    <div class="col-md-6">
      <div class="form-floating">
        <input type="password" class="form-control form-control-sm-custom" id="contrasena" placeholder="Contraseña" minlength="6" required>
        <label for="contrasena">Contraseña</label>
        <div class="invalid-feedback">
          La contraseña debe tener al menos 6 caracteres.
        </div>
      </div>
    </div>

    <!-- Confirmar Contraseña -->
    <div class="col-md-6">
      <div class="form-floating">
        <input type="password" class="form-control form-control-sm-custom" id="confirmarContrasena" placeholder="Confirmar Contraseña" required>
        <label for="confirmarContrasena">Confirmar Contraseña</label>
        <div class="invalid-feedback">
          Las contraseñas no coinciden.
        </div>
      </div>
    </div>

    <!-- Fecha de Nacimiento -->
    <div class="col-md-6 mx-auto">
      <div class="form-floating">
        <input type="date" class="form-control" id="fechaNacimiento" placeholder="Fecha nacimiento" required>
        <label for="fechaNacimiento">Fecha nacimiento</label>
        <div class="invalid-feedback">
          Por favor ingresa tu fecha de nacimiento.
        </div>
      </div>
    </div>

    <!-- Botón Registrar -->
    <div class="col-12 text-center mt-3">
      <button type="submit" class="buy-btn">Registrarse</button>
    </div>
  </form>
</div>

<!-- Script de validación de Bootstrap -->
<script>
  (function() {
    'use strict'
    const forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms)
      .forEach(function(form) {
        form.addEventListener('submit', function(event) {
          // Validación de confirmación de contraseña
          const pass = form.querySelector('#contrasena');
          const confirm = form.querySelector('#confirmarContrasena');
          if (pass.value !== confirm.value) {
            confirm.setCustomValidity('Las contraseñas no coinciden.');
          } else {
            confirm.setCustomValidity('');
          }

          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false)
      })
  })()
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const rutInput = document.getElementById('rut');
        const form = document.querySelector('form.needs-validation');

        // 1) Formatea sobre la marcha (puntos y guión)
        rutInput.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 1) {
                const dv = v.slice(-1);
                const cuerpo = v.slice(0, -1);
                e.target.value = cuerpo
                    .replace(/\B(?=(\d{3})+(?!\d))/g, '.')
                    + '-' + dv;
            } else {
                e.target.value = v;
            }
        });

        // 2) Función que calcula y comprueba el DV
        function validarRut(rut) {
            // Limpia puntos y guión
            const clean = rut.replace(/\./g, '').replace(/-/g, '').toUpperCase();
            const cuerpo = clean.slice(0, -1);
            const dv = clean.slice(-1);

            let suma = 0;
            let multiplo = 2;
            // Recorre el cuerpo de derecha a izquierda
            for (let i = cuerpo.length - 1; i >= 0; i--) {
            suma += parseInt(cuerpo.charAt(i), 10) * multiplo;
            multiplo = multiplo < 7 ? multiplo + 1 : 2;
            }

            const resto = suma % 11;
            const dvEsperado = (11 - resto) === 11 ? '0'
                            : (11 - resto) === 10 ? 'K'
                            : String(11 - resto);

            return dvEsperado === dv;
        }

        // 3) Al enviar, comprueba RUT junto al resto de validaciones
        form.addEventListener('submit', event => {
            // fuerza el chequeo de Bootstrap
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }

            // chequeo adicional de RUT
            const rutVal = rutInput.value;
            if (!validarRut(rutVal)) {
                rutInput.classList.add('is-invalid');
                rutInput.classList.remove('is-valid');
                event.preventDefault();
                event.stopPropagation();
            } else {
                rutInput.classList.add('is-valid');
                rutInput.classList.remove('is-invalid');
                }

            form.classList.add('was-validated');
        });
    });
</script>
{% endblock %}
